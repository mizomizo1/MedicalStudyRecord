name: Update README Summary

on:
  workflow_dispatch:
  issues:
    types: [closed]

permissions:
  contents: write
  issues: read

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Update README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # åŒã˜Pythonç’°å¢ƒã§requestsã‚’å…¥ã‚Œã‚‹ï¼ˆé‡è¦ï¼‰
          python -m pip install requests

          python <<'EOF'
          import os
          import re
          import requests

          # =======================
          # GitHub API è¨­å®š
          # =======================
          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["REPO"]

          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }

          # =======================
          # Issue å–å¾—ï¼ˆclosedï¼‰
          # =======================
          issues = []
          page = 1
          while True:
              r = requests.get(
                  f"https://api.github.com/repos/{repo}/issues",
                  headers=headers,
                  params={
                      "state": "closed",
                      "per_page": 100,
                      "page": page
                  }
              )
              data = r.json()
              if not data:
                  break
              issues.extend(data)
              page += 1

          # =======================
          # é›†è¨ˆ
          # =======================
          total_minutes = 0
          total_qb = 0

          for issue in issues:
              body = issue.get("body") or ""

              # --- Q-Assist / Medilinkï¼šè¬›ç¾©æ™‚é–“ï¼ˆåˆ†ï¼‰
              # Issue Form å½¢å¼ï¼š
              # ### è¬›ç¾©æ™‚é–“ï¼ˆåˆ†ï¼‰
              # 45
              m_time = re.search(r"è¬›ç¾©æ™‚é–“ï¼ˆåˆ†ï¼‰\s*\n\s*(\d+)", body)
              if m_time:
                  total_minutes += int(m_time.group(1))

              # --- QBï¼šæ¼”ç¿’å•æ•°
              # Issue Form å½¢å¼ï¼š
              # ### æ¼”ç¿’å•æ•°
              # 30
              m_qb = re.search(r"æ¼”ç¿’å•æ•°\s*\n\s*(\d+)", body)
              if m_qb:
                  total_qb += int(m_qb.group(1))

          total_hours = round(total_minutes / 60, 1)

          # =======================
          # README èª­ã¿è¾¼ã¿
          # =======================
          with open("README.md", "r", encoding="utf-8") as f:
              readme = f.read()

          # =======================
          # ã‚µãƒãƒªãƒ¼ç”Ÿæˆ
          # =======================
          totals_block = (
              "<div align=\"center\">\n\n"
              "### ğŸ§  ç·å­¦ç¿’æ™‚é–“  \n"
              f"<h1>{total_hours} <sub>h</sub></h1>\n\n"
              "### ğŸ“ QB ç´¯è¨ˆ  \n"
              f"<h1>{total_qb} <sub>å•</sub></h1>\n\n"
              "</div>"
          )

          readme = re.sub(
              r"<!-- TOTALS:START -->.*?<!-- TOTALS:END -->",
              f"<!-- TOTALS:START -->\n{totals_block}\n<!-- TOTALS:END -->",
              readme,
              flags=re.S
          )

          # =======================
          # README æ›¸ãè¾¼ã¿
          # =======================
          with open("README.md", "w", encoding="utf-8") as f:
              f.write(readme)

          print("README updated successfully")
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Update README summary" || echo "No changes"
          git push
