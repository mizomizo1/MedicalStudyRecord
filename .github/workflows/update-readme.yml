name: Update README Dashboard

on:
  workflow_dispatch:
  issues:
    types: [closed]

permissions:
  contents: write
  issues: read

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Update README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python << 'EOF'
          import os
          import re
          import requests

          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["REPO"]
          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }

          # -----------------------
          # 1. Issue を取得
          # -----------------------
          issues = []
          page = 1
          while True:
              url = f"https://api.github.com/repos/{repo}/issues"
              params = {
                  "state": "closed",
                  "per_page": 100,
                  "page": page
              }
              r = requests.get(url, headers=headers, params=params)
              data = r.json()
              if not data:
                  break
              issues.extend(data)
              page += 1

          qassist_min = 0
          medilink_min = 0
          qb_count = 0

          # -----------------------
          # 2. 集計
          # -----------------------
          for issue in issues:
              labels = {l["name"] for l in issue.get("labels", [])}
              body = issue.get("body") or ""

              # 時間（分）
              m_time = re.search(r"講義時間（分）\s*[:：]?\s*(\d+)", body)
              minutes = int(m_time.group(1)) if m_time else 0

              # QB 問数
              m_qb = re.search(r"演習問数\s*[:：]?\s*(\d+)", body)
              qb = int(m_qb.group(1)) if m_qb else 0

              if "q-assist" in labels:
                  qassist_min += minutes
              if "medilink" in labels:
                  medilink_min += minutes
              if "qb" in labels:
                  qb_count += qb

          # 分 → 時間
          qassist_h = round(qassist_min / 60, 1)
          medilink_h = round(medilink_min / 60, 1)
          total_h = round(qassist_h + medilink_h, 1)

          # -----------------------
          # 3. README を更新
          # -----------------------
          with open("README.md", "r", encoding="utf-8") as f:
              readme = f.read()

          summary = f"""| 指標 | 値 |
          |---|---|
          | **総学習時間** | **{total_h}時間** |
          | **QB 累計** | **{qb_count}問** |"""

          readme = re.sub(
              r"<!-- SUMMARY:START -->.*?<!-- SUMMARY:END -->",
              f"<!-- SUMMARY:START -->\n{summary}\n<!-- SUMMARY:END -->",
              readme,
              flags=re.S
          )

          with open("README.md", "w", encoding="utf-8") as f:
              f.write(readme)

          print("README updated")
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Update README dashboard"
          git push
