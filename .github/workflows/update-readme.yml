name: Update README Dashboard

on:
  workflow_dispatch:
  issues:
    types: [closed]

permissions:
  contents: write
  issues: read

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests

      - name: Update README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python << 'EOF'
          import os
          import re
          import requests
          from datetime import datetime, timedelta

          # =======================
          # GitHub API 設定
          # =======================
          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["REPO"]
          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }

          # =======================
          # Issue 取得（closed）
          # =======================
          issues = []
          page = 1
          while True:
              url = f"https://api.github.com/repos/{repo}/issues"
              params = {
                  "state": "closed",
                  "per_page": 100,
                  "page": page
              }
              r = requests.get(url, headers=headers, params=params)
              data = r.json()
              if not data:
                  break
              issues.extend(data)
              page += 1

          # =======================
          # 集計用変数
          # =======================
          qassist_min = 0
          medilink_min = 0
          qb_total = 0

          # QB 科目別
          qb_by_subject = {}

          # =======================
          # Issue 集計
          # =======================
          for issue in issues:
              labels = {l["name"] for l in issue.get("labels", [])}
              body = issue.get("body") or ""

              # 講義時間（分）
              m_time = re.search(r"講義時間（分）[:：]\s*(\d+)", body)
              minutes = int(m_time.group(1)) if m_time else 0

              # QB 問数
              m_qb = re.search(r"演習問数[:：]\s*(\d+)", body)
              qb_count = int(m_qb.group(1)) if m_qb else 0

              # QB 科目
              m_subject = re.search(r"科目\s*[:：]?\s*(.+)", body)
              subject = m_subject.group(1).strip() if m_subject else "その他"

              if "q-assist" in labels:
                  qassist_min += minutes

              if "medilink" in labels:
                  medilink_min += minutes

              if "qb" in labels:
                  qb_total += qb_count
                  qb_by_subject[subject] = qb_by_subject.get(subject, 0) + qb_count

          # =======================
          # 単位変換
          # =======================
          qassist_h = round(qassist_min / 60, 1)
          medilink_h = round(medilink_min / 60, 1)
          total_h = round(qassist_h + medilink_h, 1)

          # =======================
          # README 読み込み
          # =======================
          with open("README.md", "r", encoding="utf-8") as f:
              readme = f.read()

          # =======================
          # サマリー生成
          # =======================
          summary = f"""| 指標 | 値 |
          |---|---|
          | **総学習時間** | **{total_h}時間** |
          | **QB 累計** | **{qb_total}問** |"""

          # =======================
          # Mermaid：教材別時間
          # =======================
          material_chart = f"""```mermaid
          %%{{init: {{"theme": "base"}}}}%%
          xychart-beta
              title "教材別 学習時間（h）"
              x-axis ["Q-Assist", "Medilink"]
              y-axis "時間（h）" 0 --> 80
              bar [{qassist_h}, {medilink_h}]
          ```"""

          # =======================
          # Mermaid：QB 科目別
          # =======================
          subjects = list(qb_by_subject.keys())
          values = list(qb_by_subject.values())

          qb_subject_chart = f"""```mermaid
          %%{{init: {{"theme": "base"}}}}%%
          xychart-beta
              title "QB 科目別 演習問数"
              x-axis {subjects}
              y-axis "問数" 0 --> {max(values + [10])}
              bar {values}
          ```"""

          # =======================
          # README 更新
          # =======================
          def replace_block(name, content, text):
              pattern = rf"<!-- {name}:START -->.*?<!-- {name}:END -->"
              return re.sub(
                  pattern,
                  f"<!-- {name}:START -->\n{content}\n<!-- {name}:END -->",
                  text,
                  flags=re.S
              )

          readme = replace_block("SUMMARY", summary, readme)
          readme = replace_block("MATERIAL_TIME_CHART", material_chart, readme)
          readme = replace_block("QB_SUBJECT_CHART", qb_subject_chart, readme)

          # =======================
          # README 書き込み
          # =======================
          with open("README.md", "w", encoding="utf-8") as f:
              f.write(readme)

          print("README updated successfully")
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Update README dashboard"
          git push
