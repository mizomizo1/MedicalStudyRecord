on:
  workflow_dispatch:
  issues:
    types: [closed]

permissions:
  contents: write
  issues: read

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Update README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python << 'EOF'
          import os
          import re
          import requests
          from collections import defaultdict

          token = os.environ["GITHUB_TOKEN"]
          repo = os.environ["REPO"]

          headers = {
              "Authorization": f"Bearer {token}",
              "Accept": "application/vnd.github+json"
          }

          # -----------------------
          # Issue å–å¾—ï¼ˆclosedï¼‰
          # -----------------------
          issues = []
          page = 1
          while True:
              url = f"https://api.github.com/repos/{repo}/issues"
              params = {"state": "closed", "per_page": 100, "page": page}
              r = requests.get(url, headers=headers, params=params)
              data = r.json()
              if not data:
                  break
              issues.extend(data)
              page += 1

          total_minutes = 0
          total_qb = 0
          daily_minutes = defaultdict(int)

          # -----------------------
          # é›†è¨ˆ
          # -----------------------
          for issue in issues:
              body = issue.get("body") or ""
              closed_at = issue.get("closed_at")
              if not closed_at:
                  continue

              date = closed_at[:10]

              m_time = re.search(r"è¬›ç¾©æ™‚é–“ï¼ˆåˆ†ï¼‰[:ï¼š]\s*(\d+)", body)
              if m_time:
                  minutes = int(m_time.group(1))
                  total_minutes += minutes
                  daily_minutes[date] += minutes

              m_qb = re.search(r"æ¼”ç¿’å•æ•°[:ï¼š]\s*(\d+)", body)
              if m_qb:
                  total_qb += int(m_qb.group(1))

          total_hours = round(total_minutes / 60, 1)

          # -----------------------
          # README èª­ã¿è¾¼ã¿
          # -----------------------
          with open("README.md", "r", encoding="utf-8") as f:
              readme = f.read()

          # -----------------------
          # ç´¯ç©è¡¨ç¤º
          # -----------------------
          totals_block = f"""
<div align="center">

### ğŸ§  ç·å­¦ç¿’æ™‚é–“  
# **{total_hours} h**

### ğŸ“ QB ç´¯è¨ˆ  
# **{total_qb} å•**

</div>
""".strip()

          readme = re.sub(
              r"<!-- TOTALS:START -->.*?<!-- TOTALS:END -->",
              f"<!-- TOTALS:START -->\n{totals_block}\n<!-- TOTALS:END -->",
              readme,
              flags=re.S
          )

          # -----------------------
          # ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ç”Ÿæˆ
          # -----------------------
          if not daily_minutes:
              daily_minutes = {"2026-01-01": 0}

          heatmap_lines = "\n".join(
              f"    {date} : {minutes}"
              for date, minutes in sorted(daily_minutes.items())
          )

          heatmap_block = f"""```mermaid
%%{{init: {{"theme": "base"}}}}%%
calendar
    title å­¦ç¿’ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
{heatmap_lines}
```"""

          readme = re.sub(
              r"<!-- HEATMAP:START -->.*?<!-- HEATMAP:END -->",
              f"<!-- HEATMAP:START -->\n{heatmap_block}\n<!-- HEATMAP:END -->",
              readme,
              flags=re.S
          )

          # -----------------------
          # æ›¸ãè¾¼ã¿
          # -----------------------
          with open("README.md", "w", encoding="utf-8") as f:
              f.write(readme)

          print("README updated")
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "Update README dashboard" || exit 0
          git push
